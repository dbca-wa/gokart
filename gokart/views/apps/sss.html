{% extends 'layers_annotations.html' %}

{% block title %}Spatial Support System{% endblock %}

{% block tab_panels %}
{{ super() }}
<div class="tabs-panel" id="menu-tab-tracking">
    <script id="tracking-template" type="text/x-handlebars-template">
    {% raw %}
        <div class="row feature-row" data-feature-id="{{ id_ }}">
            <div class="small-12">    
                <div class="feature-title">{{ values_.label }}</div>
            </div>
        </div>
    {% endraw %}
    </script>
    <div id="tracking-list"></div>
</div>
{% endblock %}

{% block tabs %}
{{ super() }}
<li class="tabs-title side-button"><a href="#menu-tab-tracking" title="Vehicle Tracking">
    <svg class="icon"><use xlink:href="/static/images/iD-sprite.svg#icon-geolocate"></use></svg>
</a></li>
{% endblock %}

{% block loader_script %}
<script>
// load map
var symbols_url_base = "/static/symbols/device/";
var stylecache = {}
var text_style = new ol.style.Text({
    offsetX: 12,
    textAlign: "left",
    font: "12px Helvetica,Roboto,Arial,sans-serif",
    stroke: new ol.style.Stroke({ color: "#fff", width: 4 })
});
var resource_tracking_style = function(f, res) {
    var color = "_red";
    if (f.get("age") < 24) { color = "_orange" };
    if (f.get("age") < 3) { color = "_yellow" };
    if (f.get("age") <= 1) { color = "_green" };
    var style_key = f.get("symbolid") + color;
    style = stylecache[style_key]
    if (!style) {
        var icon = new ol.style.Icon({
            src: symbols_url_base + f.get("symbolid") + color + ".svg",
            opacity: .9
        });
        var style = new ol.style.Style({ image: icon, text: text_style });
        stylecache[style_key] = style
    }
    if (!f.get("label")) {
        f.set("label", f.get("name") || f.get("callsign") || f.get("rego") || f.get("deviceid"));
    }
    if (res < 0.002) {
        style.getText().setText(f.get("label"));
    } else {
        style.getText().setText("");
    }
    return style
}
var trackingTmpl = Handlebars.compile($("#tracking-template").html())
gokart.catalogue = {
    "resource_tracking_aircraft": {
        init: gokart.createWFSLayer,
        'name': "Resource Tracking Aircraft",
        'id': 'dpaw:resource_tracking',
        'style': resource_tracking_style,
        'cql_filter': "symbolid LIKE '%aircraft'"
    },
    "resource_tracking": {
        init: gokart.createWFSLayer,
        'name': "Resource Tracking",
        'id': 'dpaw:resource_tracking',
        'style': resource_tracking_style,
        'template': trackingTmpl,
        'refresh': 30
    },
    "hotspots": {
        init: gokart.createTileLayer,
        name: "Firewatch Hotspots 72hrs",
        id: "landgate:firewatch_ecu_hotspots_last_0_72",
        format: "image/png",
        refresh: 60
    },
    "state_map_base": {
        init: gokart.createTileLayer,
        'name': "State Map Base",
        'id': 'cddp:smb_250K',
        'base': true
    },
    "virtual_mosaic": {
        init: gokart.createTileLayer,
        'name': "Virtual Mosaic",
        'id': 'landgate:LGATE-V001',
        'base': true
    },
}
gokart.init([
    gokart.catalogue["resource_tracking"].init(),
    gokart.catalogue["state_map_base"].init()
]);
var trackingList = $("#tracking-list");
var renderTracking = debounce(function() {
    if (gokart.catalogue.resource_tracking.olLayer) {
        var layer = gokart.catalogue.resource_tracking.olLayer;
        var html = "";
        layer.getSource().getFeatures().forEach(function(f) {
            html += trackingTmpl(f);
        });
        trackingList.html(html);
    }
}, 250);
gokart.map.getLayerGroup().on("change", renderTracking);
</script>
{% endblock %}

{% extends 'layers_annotations.html' %}

{% block title %}Spatial Support System{% endblock %}

{% block tab_panels %}
{{ super() }}
<div class="tabs-panel" id="menu-tab-tracking">
    <script id="tracking-template" type="text/x-handlebars-template">
    {% raw %}
        <div class="row feature-row" data-feature-id="{{ id_ }}">
            <div class="small-12 columns">    
                <div class="feature-title"><img src="{{ values_.icon }}" /> {{ values_.label }} <small>({{ values_.deviceid }})</small></div>
                <small>{{ values_.time }}</small>
            </div>
        </div>
    {% endraw %}
    </script>
    <div class="row collapse">
        <div class="columns shrink">
            <ul class="tabs" data-tabs id="tracking-tabs">
                <li class="tabs-title is-active"><a href="#tracking-list-tab" aria-selected="true">Resource Tracking</a></li>
                <li class="tabs-title"><a href="#tracking-groups-tab" aria-selected="true">Device Groups</a></li>
            </ul>
        </div>
    </div>
    <div class="row collapse" id="tracking-tab-panels">
        <div class="columns">
            <div class="tabs-content vertical" data-tabs-content="tracking-tabs">
                <div id="tracking-list-tab" class="tabs-panel is-active">
                    <div class="row collapse">
                        <div class="small-6 columns">
                            <select name="select" id="resource-tracking-cql">
                                <option value="" selected>All resources</option> 
                                <option value="symbolid LIKE '%aircraft'">Aircraft</option>
                            </select>
                        </div>
                        <div class="small-6 columns">
                            <input type="search" id="resource-tracking-search" placeholder="Find a resource...">
                        </div>
                    </div>
                    <div id="tracking-list"></div>
                </div>
                <div id="tracking-groups-tab" class="tabs-panel">
                    Group search shortcuts here
                </div>
            </div>
        </div>
    </div>
    <style type="text/css">
        div.feature-row {
            cursor: pointer;
        }
        div.feature-row:hover {
            border-right: 1px solid #fff;
        }
    </style>
</div>
{% endblock %}

{% block tabs %}
{{ super() }}
<li class="tabs-title side-button"><a href="#menu-tab-tracking" title="Vehicle Tracking">
    <svg class="icon"><use xlink:href="/static/images/iD-sprite.svg#icon-geolocate"></use></svg>
</a></li>
{% endblock %}

{% block loader_script %}
<script>
// load map
var stylecache = {};
var text_style = new ol.style.Text({
    offsetX: 12,
    textAlign: "left",
    font: "12px Helvetica,Roboto,Arial,sans-serif",
    stroke: new ol.style.Stroke({ color: "#fff", width: 4 })
});
var initStyle = function(icon) {
    var imageicon = new ol.style.Icon({
        src: gokart.svgToPNG(icon),
        opacity: .9
    });
    var style = new ol.style.Style({ image: imageicon, text: text_style });
    stylecache[icon] = style
    return style;
};
var resource_tracking_style = function(f, res) {
    var color = "_red";
    if (f.get("age") < 24) { color = "_orange" };
    if (f.get("age") < 3) { color = "_yellow" };
    if (f.get("age") <= 1) { color = "_green" };
    var icon = "/static/symbols/device/" + f.get("symbolid") + color + ".svg";
    style = stylecache[icon]
    if (!style) { var style = initStyle(icon) }
    var png = gokart.pngs[style.getImage().iconImage_.src_]
    if (png) { var style = initStyle(icon) };
    if (!f.get("label")) {
        f.set("label", f.get("name") || f.get("callsign") || f.get("rego") || f.get("deviceid"));
        f.set("time", moment(f.get("seen")).toLocaleString());
    }
    if (!f.get("icon")) {
        f.set("icon", icon);
    }
    if (res < 0.002) {
        style.getText().setText(f.get("label"));
    } else {
        style.getText().setText("");
    }
    return style
};
var trackingTmpl = Handlebars.compile($("#tracking-template").html())
{% if env.WMTS_SRC %}
gokart.defaultWMTSSrc = "{{ env.WMTS_SRC }}";
{% endif %}
{% if env.WFS_SRC %}
gokart.defaultWFSSrc = "{{ env.WFS_SRC }}";
{% endif %}

gokart.catalogue = {
    "resource_tracking": {
        init: gokart.createWFSLayer,
        name: "Resource Tracking",
        id: 'dpaw:resource_tracking',
        style: resource_tracking_style,
        template: trackingTmpl,
        refresh: 30
    },
    "hotspots": {
        init: gokart.createTileLayer,
        name: "Firewatch Hotspots 72hrs",
        id: "landgate:firewatch_ecu_hotspots_last_0_72",
        format: "image/png",
        refresh: 60
    },
    "state_map_base": {
        init: gokart.createTileLayer,
        name: "State Map Base",
        id: 'cddp:smb_250K',
        base: true
    },
    "virtual_mosaic": {
        init: gokart.createTileLayer,
        name: "Virtual Mosaic",
        id: 'landgate:LGATE-V001',
        base: true
    },
};
gokart.init([
    gokart.catalogue["resource_tracking"].init(),
    gokart.catalogue["state_map_base"].init()
]);
var trackingList = $("#tracking-list");
var renderTracking = debounce(function() {
    if (gokart.catalogue.resource_tracking.olLayer) {
        var layer = gokart.catalogue.resource_tracking.olLayer;
        var html = [];
        var features = {};
        layer.getSource().getFeaturesInExtent(gokart.map.getView().calculateExtent(gokart.map.getSize())).forEach(function(f) {
            features[f.get("deviceid")] = f
        });
        Object.values(features).sort(function(a, b) {
            if (a.get("seen") > b.get("seen")) { return -1 };
            if (a.get("seen") < b.get("seen")) { return 1 };
            return 0;
        }).forEach(function(f) {
            html.push(trackingTmpl(f));
        });
        trackingList.html(html.join(""));
    }
}, 250);
trackingList.on("click", "div[data-feature-id]", function() {
    var fid = $(this).attr("data-feature-id");
    var f = gokart.catalogue.resource_tracking.olLayer.getSource().getFeatureById(fid);
    gokart.map.getView().setCenter(f.getGeometry().getCoordinates());
    if (gokart.get_scale() > 250) {
        gokart.set_scale(250)
    }
})
$("#resource-tracking-cql").on("change", function() {
    gokart.catalogue.resource_tracking.cql_filter = $(this).val();
    gokart.catalogue.resource_tracking.olLayer.getSource().clear();
}).change();
gokart.map.getLayerGroup().on("change", renderTracking);
gokart.map.getView().on("propertychange", renderTracking);
$("#resource-tracking-search").on("change", renderTracking);
</script>
{% endblock %}
